<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="./node_modules/font-awesome/css/font-awesome.min.css"/>

    <title>.GE დომენები</title>
    <style type="text/css">
        body {
            color: #2d527c;
            font-family: MarkGEO-Regular;
            font-size:16px;
        }

        h1 {
            font-family: MarkGEOCAPS-Regular;
        }

        .btn {
             border-radius: 5px;
             padding: 15px 25px;
             font-size: 22px;
             text-decoration: none;
             margin: 20px;
             color: #fff;
             position: relative;
             display: inline-block;
         }
        .btn:active {
            transform: translate(0px, 5px);
            -webkit-transform: translate(0px, 5px);
            box-shadow: 0px 1px 0px 0px;
        }

        .btn_sm {
           border-radius: 5px;
           text-decoration: none;
           position: relative;
           display: inline-block;
           font-size:13px;
           margin:5px;
           padding:10px 15px;
        }
       .btn_sm:active {
           transform: translate(0px, 2px);
           -webkit-transform: translate(0px, 2px);
           box-shadow: 0px 1px 0px 0px;
       }

        .blue {
            background-color: #55acee;
            box-shadow: 0px 5px 0px 0px #3C93D5;
        }
        .blue:hover {
            background-color: #6FC6FF;
        }

        .gray_sm {
            color:#7a7a7a;
            background-color: #f9f9f9;
            box-shadow: 0px 2px 0px 0px #d6d6d6;
        }
        .gray_sm:hover {
            background-color: #eeeeee;
        }
                 
        .gray {
            color:#7a7a7a;
            background-color: #f9f9f9;
            box-shadow: 0px 5px 0px 0px #d6d6d6;
        }
        .gray:hover {
            background-color: #eeeeee;
        }

        section {
            font-family: MarkGEO-Regular;
            margin-left: 22px;
            font-size:16px;
            background: #fff;
            width: 420px;
            height: 350px;
            resize: none;
            border: 2px dashed #2d527c;
            outline: 0;
            overflow-y:auto;
        }

        section div {
            border-bottom: 1px dashed #2d527c;
        }

        section span {
            float: right;
            padding-right:5px;
            padding-top:1px;
        }

        input {
            padding:5px;
            font-family: MarkGEO-Regular;
            font-size:15px;
            width: 5px;
            border: 0px;
            outline: 0px;
            max-width:270px;
        }

        select {
            height: 60px;
        }

        @font-face {
            font-family: MarkGEO-Regular;
            src: url("./assets/fonts/MarkGEO-Regular.eot?#iefix") format("embedded-opentype"),
            url("./assets/fonts/MarkGEO-Regular.woff") format("woff"),
            url("./assets/fonts/MarkGEO-Regular.ttf") format("truetype"),
            url("./assets/fonts/MarkGEO-Regular.svg#MarkGEO-Regular") format("svg");
            font-weight:normal;
            font-style:normal;
        }

        @font-face {
            font-family: MarkGEOCAPS-Regular;
            src: url("./assets/fonts/MarkGEOCAPS-Regular.eot?#iefix") format("embedded-opentype"),
            url("./assets/fonts/MarkGEOCAPS-Regular.woff") format("woff"),
            url("./assets/fonts/MarkGEOCAPS-Regular.ttf") format("truetype"),
            url("./assets/fonts/MarkGEOCAPS-Regular.svg#MarkGEOCAPS-Regular") format("svg");
            font-weight:normal;
            font-style:normal;
        }

        .text-blue {
            color: #2d527c;
        }
        .text-red {
            color: #ce594e;
        }

        #main-actions a {
            display: inline;
        }

        #main-actions {
            margin-left: 8px;
            margin-top: 50px;
        }
    </style>
</head>
<body>
<h1>GE დომენების შემოწმება</h1>

<div style="margin-top:45px;">
    <section>
        <div>
            <input />
            <span></span>
        </div>
    </section>
</div>

<div style="margin-left:22px;margin-top:10px;">
    <a data-toggle="history" href="#" class="btn_sm gray_sm"><i class="fa fa-history"></i></a>
    <a id="copy" href="#" class="btn_sm gray_sm"><i class="fa fa-copy"></i> კოპირება</a>
    <a id="paste" href="#" class="btn_sm gray_sm"><i class="fa fa-paste"></i> ჩასმა</a>
    <a id="clear" href="#" class="btn_sm gray_sm"><i class="fa fa-remove"></i> გასუფთავება</a>
</div>

<div id="main-actions">
    <a id="save" href="#" class="btn gray">დამახსოვრება</a>
    <a id="check" href="#" class="btn blue">შემოწმება</a>
</div>

<script>
    "use strict";
    // You can also require other files to run in this process
    require('./renderer.js')
    window.$ = window.jQuery = require('jquery');

    const SEC_LIMIT = 120; // Seconds to keep records in memory

    $(document).on('keypress',"section input",function(e){
        if (e.keyCode == 13){

            if ($(this).val().length < 2 || !/^[A-Za-z0-9\-\.]+$/.test($(this).val())) {
                return;
            }
            original_input.clone().val("").appendTo($(this).parent().parent()).wrap("<div/>").after("<span/>").focus();

            //$(this).next().remove(); // remove status (if possible), will be inserted with next line (erase, return)
            //$(this).after($(this).clone().val("")).after("<div/>").after("<span></span>");
            //$(this).next().next().next().focus();

            checkDomain($(this));
        }
    });

    $(document).on('keyup',"section input",function(e){
        if (e.keyCode == 8) { // backspace
            if ($(this).get(0).selectionStart === 0) {

                $(this).parent().prev().find("input").focus();

                //var prev = $(this).prev().prev().prev();
                //prev.focus();

                //if ($(this).val() == "" && $(this).parent().length > 0) {
                if ($(this).val() == "" && $($(this).parent().parent().children()).length > 1) {
                    ///// don't remove status
                    ////$(this).prev().prev().remove();
                    //$(this).prev().remove();
                    //$(this).remove();
                    $(this).parent().remove();
                }
            } else if ($(this).get(0).selectionStart === $(this).val().length) {
                // clear status
                $(this).next().text("");
            }
        } else if (e.keyCode == 38) { // up
            $(this).parent().prev().find("input").focus();
            //$(this).prev().prev().prev().focus();
        } else if (e.keyCode == 40) { //down
            $(this).parent().next().find("input").focus();
            //$(this).next().next().next().focus();
        }
    });

    function setInputWidth(input) {
        $(input).css("width", (($(input).val().length + 1) * 9.7) + 'px');
    }
    $(document).on('keydown',"section input",function(e){
       setInputWidth($(this));
    });

    // focus on click
    $(document).on("click", "section, section div", function(e) {
        if (e.target !== this) {
            return;
        }

        $(this).find("input").last().focus();
    });

    //
    var original_input;
    $(document).ready(function(){
       $("input").focus();
       original_input = $("input")
    });

    //
    var store = {}
    function checkDomain(input) {
        var domain = input.val();

        if (domain.length < 2) {
            return;
        }

        var match = domain.match(/(.+)\.ge$/)
        if (match !== null) {
            domain = match[1];
        }

        if (store.hasOwnProperty(domain)) {
            var now = new Date().getTime();

            if (Math.floor((now - store[domain][0]) / 1000) <= SEC_LIMIT) {
                input.next().html(store[domain][1]);
                return;
            }
            delete store[domain];
        }


        input.next().text("მოწმდება...")

        //store[domain] = [+new Date(), '<span class="text-blue">თავისუფალია</span>'];
        //input.next().html('<span class="text-blue">თავისუფალია</span>');
        //return;

        $.ajax({
            url: 'http://nic.net.ge/Home/DomainCheck',
            type: 'post',
            data: {
                "Domain": domain,
                "TopLevelDomain": ".ge"
            },
            headers: {
                "X-Requested-With": 'XMLHttpRequest'
            },
            success: function (data, textStatus, jqXHR) {
                var msg = /დაკავებულია/.test(data['Data']) ?
                    '<span class="text-red">დაკავებულია</span>' : /არასწორი დომენური სახელი/.test(data['Data']) ?
                        '<span class="text-red">სახელი არასწორია</span>' : '<span class="text-blue">თავისუფალია</span>';

                input.next().html(msg);

                store[domain] = [+new Date(), msg];
            }
        });
    }

    $("#check").on("click", function(){
        var check = 0;
        $("input").each(function(i, el){
            if ($(el).val().length < 2) {
                console.log("<2");
                return;
            }

            $(this).next().remove();
            $(this).after("<span></span>");

            checkDomain($(el));
            check = 1;
        });
        if (check === 0) {
            ipc.send('open-error-dialog-check')
        }
    });

    // copy paste
    const {clipboard} = require('electron')

    $("#copy").click(function(){
        var text = Array.from(
            $('input').filter(
                (i, el) => $(el).val().length > 1
            ).map(
                (i, el) => {
                    var domain = $(el).val();
                    if (!/.+\.ge$/.test(domain)) {
                        domain += ".ge";
                    }

                    var status = $(el).next().text()
                    domain += (status.length > 0) ? ' (' + status + ')' : '';
                    return domain;
                }
            )
        ).join("\n");

        clipboard.writeText(text);
    });

    $("#paste").click(function(){
        var domains = clipboard.readText().match(/[a-zA-Z0-9\-\.]+\.ge/g)

        if (domains.length == 0) {
            return;
        }

        $("section").text("");
        $.each(domains, function(i, v) {
            var input = original_input.clone().val(v).appendTo("section").wrap("<div/>").after("<span/>");

            setInputWidth(input);
        });
    });

    // clear

    $("#clear").click(function(){
        $("section").text("");
        original_input.clone().val("").appendTo("section").wrap("<div/>").after("<span/>").focus();
    });

    //

    const remote = require('electron').remote;
    const BrowserWindow = remote.BrowserWindow;

    $("[data-toggle=history]").click(function(){
        storage.getAll(function(error, data) {
            if (error) throw error;
            if ($.isEmptyObject(data)) {
                ipc.send('open-error-dialog-history')
            } else {
                var win = new BrowserWindow({
                    parent: remote.getCurrentWindow(),
                    modal: true,
                    width: 300,
                    height: 500,
                    show: false,
                    backgroundColor: '#fffff'
                });

                win.loadURL('file://' + __dirname + '/history.html')
                win.once('ready-to-show', () => {
                    win.show()
                win.focus()
            });
            }
        });
    });

    const ipc = require('electron').ipcRenderer

    ipc.on('load-version', function(arg, val) {
        storage.get(val, function(error, data) {
            if (error) throw error;

            data = JSON.parse(data);

            if ($.isEmptyObject(data)) {
                return;
            }

            $("section").text("");
            $.each(data, function(i, v) {
                //var input = original_input.clone().val(v).appendTo("section").after("<div/>").after("<span></span>");
                var input = original_input.clone().val(v).appendTo("section").wrap("<div/>").after("<span/>");

                setInputWidth(input);
            });
        });
    });

    const os = require('os');
    const storage = require('electron-json-storage');

    storage.setDataPath(os.tmpdir() + '/ge_domains');

    $("#save").on("click", function(e){
        var all = Array.from($('input').filter((i, el) => $(el).val().length > 1).map((i, el) => $(el).val()));
        if (all.length == 0) {
            return;
        }

        var json = JSON.stringify(all);

        var date = new Date();
        date = [
            '0' + date.getDate(),
            '0' + (date.getMonth() + 1),
            '' + date.getFullYear(),
            '0' + date.getHours(),
            '0' + date.getMinutes(),
            '0' + date.getSeconds()
        ].map(component => component.slice(-2));

        console.log(date);

        date = date.slice(0, 3).join('-') + ' ' + date.slice(3).join(':');

        storage.set('' + date, json);

        e.preventDefault();
    });
</script>

</body>
</html>
